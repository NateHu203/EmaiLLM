<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmaiLLM - Bulk Cleanser</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .header {
            background-color: #4267b2;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo i {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .user-info {
            font-size: 14px;
        }
        
        .sidebar {
            background-color: #f0f2f5;
            padding: 15px;
            height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .folder {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .folder:hover {
            background-color: #e4e6eb;
        }
        
        .folder.active {
            background-color: #e7f3ff;
            color: #1877f2;
            font-weight: 500;
        }
        
        .folder-count {
            background-color: #dfe1e6;
            color: #606770;
            border-radius: 10px;
            font-size: 12px;
            padding: 2px 8px;
        }
        
        .search-box {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid #ddd;
        }
        
        .email-list {
            height: calc(100vh - 250px);
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        
        .email-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .email-item:hover {
            background-color: #f5f7fa;
        }
        
        .email-item.selected {
            background-color: #e7f3ff;
        }
        
        .email-item .star {
            color: #f1c40f;
            margin-right: 6px;
            visibility: hidden;
        }
        
        .email-item.starred .star {
            visibility: visible;
        }
        
        .email-date {
            color: #65676b;
            font-size: 12px;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .email-sender {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .email-subject {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .email-preview {
            color: #65676b;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 4px;
            margin-top: 4px;
        }
        
        .tag-networking {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .tag-internship {
            background-color: #d6eaff;
            color: #0984e3;
        }
        
        .tag-club-events {
            background-color: #d4f5e9;
            color: #00b894;
        }
        
        .details-pane {
            padding: 20px;
            height: calc(100vh - 250px);
            overflow-y: auto;
        }
        
        .details-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        
        .details-subject {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .details-info {
            color: #65676b;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .details-content {
            line-height: 1.5;
            white-space: pre-line;
        }
        
        .chat-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            border-left: 1px solid #ddd;
        }
        
        .chat-header {
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #4267b2;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f5f7fa;
            border-radius: 4px;
            height: calc(100vh - 350px);
        }
        
        .chat-input {
            display: flex;
        }
        
        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            max-width: 70%;
        }
        
        .user-message {
            background-color: #e7f3ff;
            color: #1877f2;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message {
            background-color: #f0f2f5;
            align-self: flex-start;
        }
        
        .loading-dots {
            display: inline-flex;
            justify-content: center;
            width: 50px;
        }
        
        .loading-dots span {
            animation: blink 1.4s infinite both;
            width: 5px;
            height: 5px;
            margin: 0 2px;
            background-color: #aaa;
            border-radius: 50%;
            display: inline-block;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        .section-header {
            font-weight: 500;
            color: #65676b;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .btn-classify {
            margin-top: 10px;
        }
        
        .resize-handle {
            width: 8px;
            height: 100%;
            background-color: #ddd;
            cursor: col-resize;
            position: absolute;
            right: -4px;
            top: 0;
            opacity: 0.3;
            transition: opacity 0.2s, background-color 0.2s;
            z-index: 100;
        }
        
        .resize-handle:hover, .resize-handle.active {
            opacity: 1;
            background-color: #4267b2;
        }
        
        .col-resizable {
            position: relative;
            transition: width 0.1s;
            overflow: visible;
        }
        
        .container.py-4 {
            max-width: 100%;
            padding-left: 30px;
            padding-right: 30px;
        }
        
        /* Add these CSS styles for the category management */
        .category-management {
            margin-bottom: 15px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
        }
        
        .category-showcase {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .category-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e7f3ff;
            color: #1877f2;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .category-badge:hover {
            background-color: #d0e3f7;
        }
        
        .category-badge i {
            margin-right: 5px;
        }
        
        .delete-category {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #8c8c8c;
            margin-left: 6px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            font-size: 10px;
            border-radius: 50%;
        }
        
        .delete-category:hover {
            background-color: rgba(0,0,0,0.1);
            color: #ff4d4f;
        }
        
        .section-header.small {
            font-size: 12px;
            margin-top: 10px;
            margin-bottom: 8px;
        }
        
        /* Adjust chat messages to have less height due to added category section */
        .chat-messages {
            height: calc(100vh - 450px);
        }
        
        /* Add notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-success {
            background-color: #52c41a;
        }
        
        .notification-warning {
            background-color: #faad14;
        }
        
        .notification-error {
            background-color: #f5222d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="app-container">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <i class="fas fa-envelope"></i>
                    <h3 class="mb-0">EmailAssistant</h3>
                </div>
                <div class="user-info">
                    user@example.com
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="row no-gutters">
                <!-- Sidebar -->
                <div class="col-md-3 col-resizable" id="sidebar-col">
                    <div class="resize-handle" id="sidebar-resize"></div>
                    <div class="sidebar">
                        <div class="folder active">
                            <span><i class="fas fa-inbox"></i> Inbox</span>
                            <span class="folder-count">{{ emails|length }}</span>
                        </div>
                        
                        <div class="section-header">KEYWORD FOLDERS</div>
                        {% for keyword in keywords %}
                        <div class="folder">
                            <span>
                                {% if keyword == 'networking' %}
                                <i class="fas fa-network-wired text-warning"></i>
                                {% elif keyword == 'internship' %}
                                <i class="fas fa-briefcase text-primary"></i>
                                {% elif keyword == 'club events' %}
                                <i class="fas fa-calendar-alt text-success"></i>
                                {% else %}
                                <i class="fas fa-tag"></i>
                                {% endif %}
                                {{ keyword|title }}
                            </span>
                            <span class="folder-count">
                                {{ emails_by_keyword[keyword]|length if emails_by_keyword is defined and keyword in emails_by_keyword else 0 }}
                            </span>
                        </div>
                        {% endfor %}
                        
                        <div class="folder">
                            <span><i class="fas fa-archive text-secondary"></i> Untagged</span>
                            <span class="folder-count">{{ emails_by_keyword['untagged']|length if emails_by_keyword is defined else emails|length }}</span>
                        </div>
                        
                        <div class="section-header">FOLDERS</div>
                        <div class="folder">
                            <span><i class="fas fa-star text-warning"></i> Important</span>
                            <span class="folder-count">0</span>
                        </div>
                        <div class="folder">
                            <span><i class="fas fa-archive"></i> Archive</span>
                            <span class="folder-count">0</span>
                        </div>
                        <div class="folder">
                            <span><i class="fas fa-trash-alt"></i> Trash</span>
                            <span class="folder-count">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Email List and Details -->
                <div class="col-md-9" id="main-content-col">
                    <div class="row no-gutters">
                        <!-- Search Box -->
                        <div class="col-12">
                            <div class="search-box">
                                <form action="{{ url_for('search') }}" method="GET">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-white border-right-0">
                                                <i class="fas fa-search text-muted"></i>
                                            </span>
                                        </div>
                                        <input type="text" class="form-control border-left-0" name="q" placeholder="Club Events OR Networking OR Internship" value="{{ search_query }}">
                                        {% if search_query %}
                                        <div class="input-group-append">
                                            <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">Clear</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Email List -->
                        <div class="col-md-5 col-resizable" id="email-list-col">
                            <div class="resize-handle" id="email-list-resize"></div>
                            <div class="email-list">
                                {% for email in emails %}
                                <div class="email-item {% if loop.first %}selected{% endif %}" data-id="{{ loop.index0 }}" onclick="selectEmail({{ loop.index0 }})">
                                    <div class="email-date">{{ email.date.split(' ')[1] ~ ' ' ~ email.date.split(' ')[0] }}</div>
                                    <div class="email-sender">{{ email.sender_email }}</div>
                                    <div class="email-subject">{{ email.subject }}</div>
                                    <div class="email-preview">{{ email.content|truncate(100) }}</div>
                                    
                                    {% if email.tags %}
                                    <div class="email-tags">
                                        {% for tag in email.tags %}
                                        <span class="tag tag-{{ tag|replace(' ', '-') }}">
                                            {% if tag == 'networking' %}
                                            <i class="fas fa-network-wired"></i>
                                            {% elif tag == 'internship' %}
                                            <i class="fas fa-briefcase"></i>
                                            {% elif tag == 'club events' %}
                                            <i class="fas fa-calendar-alt"></i>
                                            {% else %}
                                            <i class="fas fa-tag"></i>
                                            {% endif %}
                                            {{ tag }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Email Details -->
                        <div class="col-md-4 col-resizable" id="email-details-col">
                            <div class="resize-handle" id="email-details-resize"></div>
                            <div class="details-pane">
                                {% if emails %}
                                <div class="details-header">
                                    <div class="details-subject" id="email-subject">{{ emails[0].subject }}</div>
                                    <div class="details-info">From: <span id="email-from">{{ emails[0].sender_name }} &lt;{{ emails[0].sender_email }}&gt;</span></div>
                                    <div class="details-info">To: <span id="email-to">{{ emails[0].recipients }}</span></div>
                                    <div class="details-info">Date: <span id="email-date">{{ emails[0].date }}</span></div>
                                </div>
                                <div class="details-content" id="email-content">
                                    {{ emails[0].content }}
                                </div>
                                
                                <button class="btn btn-primary btn-classify" onclick="classifyCurrentEmail()">
                                    <i class="fas fa-tags"></i> Classify Email
                                </button>
                                <div id="classification-result" class="mt-3"></div>
                                {% else %}
                                <div class="text-center p-5">
                                    <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                                    <p>Select an email to view details</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Chat Column -->
                        <div class="col-md-3 col-resizable" id="chat-col">
                            <div class="chat-container">
                                <div class="chat-header">
                                    <i class="fas fa-robot"></i> Email Assistant
                                </div>
                                
                                <!-- Categories Management Section -->
                                <div class="category-management mb-3">
                                    <div class="section-header small">CATEGORIES</div>
                                    <div class="input-group mb-2">
                                        <input type="text" id="category-input" class="form-control" placeholder="Enter new category..." aria-label="Category name">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-primary" type="button" id="add-category-btn">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Category Showcase -->
                                    <div class="category-showcase" id="category-showcase">
                                        <!-- Categories will be added here dynamically -->
                                        {% if keywords %}
                                            {% for keyword in keywords %}
                                            <span class="category-badge">
                                                {% if keyword == 'networking' %}
                                                <i class="fas fa-network-wired text-warning"></i>
                                                {% elif keyword == 'internship' %}
                                                <i class="fas fa-briefcase text-primary"></i>
                                                {% elif keyword == 'club events' %}
                                                <i class="fas fa-calendar-alt text-success"></i>
                                                {% else %}
                                                <i class="fas fa-tag"></i>
                                                {% endif %}
                                                {{ keyword }}
                                                <button class="delete-category" data-category="{{ keyword }}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="section-header small">CHAT</div>
                                <div class="chat-messages" id="chat-messages">
                                    <div class="ai-message message">
                                        Hi there! I can help you analyze and understand this email. What would you like to know?
                                    </div>
                                </div>
                                <div class="chat-input">
                                    <input type="text" id="chat-input-field" placeholder="Ask about this email...">
                                    <button class="btn btn-primary" onclick="sendChatMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    
    <script>
        // Current selected email
        let currentEmailId = 0;
        
        // Select email function
        function selectEmail(emailId) {
            // Update current email ID
            currentEmailId = emailId;
            
            // Remove selected class from all emails
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked email
            document.querySelectorAll('.email-item')[emailId].classList.add('selected');
            
            // Get email data
            const emails = {{ emails|tojson }};
            const email = emails[emailId];
            
            // Update details pane
            document.getElementById('email-subject').textContent = email.subject;
            document.getElementById('email-from').textContent = `${email.sender_name} <${email.sender_email}>`;
            document.getElementById('email-to').textContent = email.recipients;
            document.getElementById('email-date').textContent = email.date;
            document.getElementById('email-content').textContent = email.content;
            
            // Clear chat messages
            document.getElementById('chat-messages').innerHTML = `
                <div class="ai-message message">
                    Hi there! I can help you analyze and understand this email. What would you like to know?
                </div>
            `;
            
            // Clear classification result
            const resultElement = document.getElementById('classification-result');
            if (resultElement) {
                resultElement.innerHTML = '';
            }
        }
        
        // Classify current email function
        function classifyCurrentEmail() {
            const resultElement = document.getElementById('classification-result');
            resultElement.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Classifying email...
                </div>
            `;
            
            // Simulate API call with fetch
            setTimeout(() => {
                fetch('/classify-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email_id: currentEmailId
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Generate tag HTML
                        let tagsHtml = '';
                        if (data.tags.length > 0) {
                            tagsHtml = '<div class="mt-2">';
                            data.tags.forEach(tag => {
                                tagsHtml += `
                                    <span class="tag tag-${tag.replace(' ', '-')}">
                                        ${getTagIcon(tag)} ${tag}
                                    </span>
                                `;
                            });
                            tagsHtml += '</div>';
                            
                            resultElement.innerHTML = `
                                <div class="alert alert-success">
                                    <strong>Classification complete!</strong><br>
                                    This email has been tagged with:${tagsHtml}
                                </div>
                            `;
                            
                            // Update tags in the email list item
                            const emailItem = document.querySelectorAll('.email-item')[currentEmailId];
                            let tagsElement = emailItem.querySelector('.email-tags');
                            if (!tagsElement) {
                                tagsElement = document.createElement('div');
                                tagsElement.className = 'email-tags';
                                emailItem.appendChild(tagsElement);
                            }
                            tagsElement.innerHTML = tagsHtml;
                        } else {
                            resultElement.innerHTML = `
                                <div class="alert alert-info">
                                    <strong>Classification complete!</strong><br>
                                    No relevant tags found for this email.
                                </div>
                            `;
                        }
                    } else {
                        resultElement.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Error:</strong> ${data.message || 'Failed to classify email.'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    resultElement.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    `;
                });
            }, 1500); // Simulate network delay
        }
        
        // Send chat message function
        function sendChatMessage() {
            const inputField = document.getElementById('chat-input-field');
            const message = inputField.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML += `
                <div class="user-message message">
                    ${message}
                </div>
            `;
            
            // Add loading indicator
            chatMessages.innerHTML += `
                <div class="ai-message message" id="ai-typing">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Clear input field
            inputField.value = '';
            
            // Simulate API call
            setTimeout(() => {
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        email_id: currentEmailId
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Remove loading indicator
                    document.getElementById('ai-typing').remove();
                    
                    if (data.status === 'success') {
                        chatMessages.innerHTML += `
                            <div class="ai-message message">
                                ${data.response}
                            </div>
                        `;
                    } else {
                        chatMessages.innerHTML += `
                            <div class="ai-message message">
                                I'm sorry, I encountered an error while processing your request.
                            </div>
                        `;
                    }
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(error => {
                    // Remove loading indicator
                    document.getElementById('ai-typing').remove();
                    
                    chatMessages.innerHTML += `
                        <div class="ai-message message">
                            I'm sorry, I encountered an error: ${error.message}
                        </div>
                    `;
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }, 1000); // Simulate network delay
        }
        
        // Helper function to get tag icon
        function getTagIcon(tag) {
            switch(tag) {
                case 'networking':
                    return '<i class="fas fa-network-wired"></i>';
                case 'internship':
                    return '<i class="fas fa-briefcase"></i>';
                case 'club events':
                    return '<i class="fas fa-calendar-alt"></i>';
                default:
                    return '<i class="fas fa-tag"></i>';
            }
        }
        
        // Add event listener for chat input
        document.getElementById('chat-input-field').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // Column Resize Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Get column elements
            const sidebarCol = document.getElementById('sidebar-col');
            const mainContentCol = document.getElementById('main-content-col');
            const emailListCol = document.getElementById('email-list-col');
            const emailDetailsCol = document.getElementById('email-details-col');
            const chatCol = document.getElementById('chat-col');
            
            // Get resize handle elements
            const sidebarResize = document.getElementById('sidebar-resize');
            const emailListResize = document.getElementById('email-list-resize');
            const emailDetailsResize = document.getElementById('email-details-resize');
            
            // Variables for tracking resize state
            let isResizing = false;
            let currentResizer = null;
            let initialWidth = 0;
            let initialX = 0;
            let initialTotal = 0;
            
            // Initialize column widths with explicit percentage values
            const setInitialWidths = () => {
                // Set main sections (sidebar and content)
                if (!sidebarCol.style.width) sidebarCol.style.width = '25%';
                if (!mainContentCol.style.width) mainContentCol.style.width = '75%';
                
                // Set content subsections
                if (!emailListCol.style.width) emailListCol.style.width = '41.67%'; // 5/12 of content
                if (!emailDetailsCol.style.width) emailDetailsCol.style.width = '33.33%'; // 4/12 of content
                if (!chatCol.style.width) chatCol.style.width = '25%'; // 3/12 of content
            };
            
            setInitialWidths();
            
            // Start resize process
            function startResize(e) {
                e.preventDefault();
                isResizing = true;
                
                // Determine which resizer was clicked
                if (e.target === sidebarResize) {
                    currentResizer = 'sidebar';
                    initialWidth = sidebarCol.offsetWidth;
                    // We're resizing the main sidebar vs content split
                    initialTotal = sidebarCol.parentElement.offsetWidth;
                } else if (e.target === emailListResize) {
                    currentResizer = 'emailList';
                    initialWidth = emailListCol.offsetWidth;
                    // We're working within the content pane
                    initialTotal = emailListCol.parentElement.offsetWidth;
                } else if (e.target === emailDetailsResize) {
                    currentResizer = 'emailDetails';
                    initialWidth = emailDetailsCol.offsetWidth;
                    // We're working within the content pane
                    initialTotal = emailDetailsCol.parentElement.offsetWidth;
                }
                
                initialX = e.clientX;
                
                // Add visual feedback
                e.target.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                // Add event listeners for resize process
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                
                // Log initial info
                console.log(`Starting resize: ${currentResizer}`, {
                    initialWidth,
                    initialTotal,
                    initialX
                });
            }
            
            // Handle resize during mouse movement
            function resize(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - initialX;
                const newWidth = initialWidth + deltaX;
                const newPercent = (newWidth / initialTotal) * 100;
                
                // Apply constraints and resize based on which element is being resized
                if (currentResizer === 'sidebar') {
                    // Limit sidebar width between 15% and 40%
                    if (newPercent >= 15 && newPercent <= 40) {
                        sidebarCol.style.width = `${newPercent}%`;
                        mainContentCol.style.width = `${100 - newPercent}%`;
                        console.log(`Sidebar resize: ${newPercent.toFixed(2)}%`);
                    }
                } else if (currentResizer === 'emailList') {
                    // Limit email list width between 20% and 60%
                    if (newPercent >= 20 && newPercent <= 60) {
                        emailListCol.style.width = `${newPercent}%`;
                        
                        // Adjust the other columns to maintain 100% total
                        const remainingWidth = 100 - newPercent;
                        const detailsRatio = emailDetailsCol.offsetWidth / (emailDetailsCol.offsetWidth + chatCol.offsetWidth);
                        
                        const newDetailsWidth = remainingWidth * detailsRatio;
                        const newChatWidth = remainingWidth - newDetailsWidth;
                        
                        emailDetailsCol.style.width = `${newDetailsWidth}%`;
                        chatCol.style.width = `${newChatWidth}%`;
                        
                        console.log(`Email list resize: ${newPercent.toFixed(2)}%`);
                    }
                } else if (currentResizer === 'emailDetails') {
                    // Limit email details width between 20% and 60%
                    if (newPercent >= 20 && newPercent <= 60) {
                        emailDetailsCol.style.width = `${newPercent}%`;
                        
                        // Adjust chat column to maintain 100% total
                        // Email list remains the same
                        const emailListWidth = parseFloat(emailListCol.style.width);
                        const newChatWidth = 100 - emailListWidth - newPercent;
                        
                        // Make sure chat column isn't too small
                        if (newChatWidth >= 15) {
                            chatCol.style.width = `${newChatWidth}%`;
                            console.log(`Email details resize: ${newPercent.toFixed(2)}%`);
                        }
                    }
                }
            }
            
            // End resize process
            function stopResize() {
                if (!isResizing) return;
                
                isResizing = false;
                
                // Remove visual feedback
                document.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.classList.remove('active');
                });
                
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // Remove event listeners
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                
                console.log('Resize complete');
            }
            
            // Attach event listeners to resize handles
            if (sidebarResize) {
                sidebarResize.addEventListener('mousedown', startResize);
            } else {
                console.error('Sidebar resize handle not found');
            }
            
            if (emailListResize) {
                emailListResize.addEventListener('mousedown', startResize);
            } else {
                console.error('Email list resize handle not found');
            }
            
            if (emailDetailsResize) {
                emailDetailsResize.addEventListener('mousedown', startResize);
            } else {
                console.error('Email details resize handle not found');
            }
            
            // Add window resize handler to maintain relative proportions
            window.addEventListener('resize', function() {
                console.log('Window resized, maintaining column proportions');
            });
            
            // Log that initialization is complete
            console.log('Resize handlers initialized');
        });

        // Add these category management functions 
        function initCategoryManagement() {
            const addButton = document.getElementById('add-category-btn');
            const categoryInput = document.getElementById('category-input');
            const categoryShowcase = document.getElementById('category-showcase');
            
            // Setup event listeners
            addButton.addEventListener('click', addCategory);
            categoryInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCategory();
                }
            });
            
            // Setup delete button listeners for existing categories
            setupDeleteButtons();
            
            function addCategory() {
                const categoryName = categoryInput.value.trim().toLowerCase();
                if (!categoryName) return;
                
                // Check if category already exists
                const existingCategories = getExistingCategories();
                if (existingCategories.includes(categoryName)) {
                    showNotification('Category already exists', 'warning');
                    return;
                }
                
                // Create new category badge
                const categoryBadge = document.createElement('span');
                categoryBadge.className = 'category-badge';
                
                // Add icon based on category name
                let iconHtml = '';
                if (categoryName === 'networking') {
                    iconHtml = '<i class="fas fa-network-wired text-warning"></i>';
                } else if (categoryName === 'internship') {
                    iconHtml = '<i class="fas fa-briefcase text-primary"></i>';
                } else if (categoryName === 'club events') {
                    iconHtml = '<i class="fas fa-calendar-alt text-success"></i>';
                } else {
                    iconHtml = '<i class="fas fa-tag"></i>';
                }
                
                categoryBadge.innerHTML = `
                    ${iconHtml}
                    ${categoryName}
                    <button class="delete-category" data-category="${categoryName}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add to showcase
                categoryShowcase.appendChild(categoryBadge);
                
                // Clear input
                categoryInput.value = '';
                
                // Add delete listener to new badge
                setupDeleteButtons();
                
                // Save to backend
                saveCategoryToBackend(categoryName);
            }
            
            function setupDeleteButtons() {
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const category = this.getAttribute('data-category');
                        this.parentElement.remove();
                        deleteCategoryFromBackend(category);
                    });
                });
            }
            
            function getExistingCategories() {
                const categories = [];
                document.querySelectorAll('.category-badge').forEach(badge => {
                    // Extract text content without the delete button text
                    const categoryText = badge.textContent.trim().split('\n')[0].trim();
                    categories.push(categoryText.toLowerCase());
                });
                return categories;
            }
            
            function saveCategoryToBackend(category) {
                // New implementation goes here (replace existing function)
                // Call API to save category to .env
                fetch('/add-category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Category added successfully', 'success');
                        
                        // Update the sidebar keyword folders
                        updateSidebarKeywords(data.keywords);
                    } else {
                        showNotification('Failed to add category', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving category:', error);
                    showNotification('Error saving category', 'error');
                });
            }
            
            function deleteCategoryFromBackend(category) {
                // New implementation goes here (replace existing function)
                // Call API to remove category from .env
                fetch('/delete-category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Category removed', 'success');
                        
                        // Update the sidebar keyword folders
                        updateSidebarKeywords(data.keywords);
                    } else {
                        showNotification('Failed to remove category', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error removing category:', error);
                    showNotification('Error removing category', 'error');
                });
            }
            
            function showNotification(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                
                // Add to body
                document.body.appendChild(notification);
                
                // Show with animation
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-remove after delay
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
            
            // Add this new function after the previous two
            function updateSidebarKeywords(keywords) {
                const keywordFoldersContainer = document.querySelector('.sidebar .section-header + div').parentElement;
                const sectionHeader = keywordFoldersContainer.querySelector('.section-header');
                
                // Clear existing keyword folders
                const existingFolders = keywordFoldersContainer.querySelectorAll('.folder:not(:first-child):not(:last-child)');
                existingFolders.forEach(folder => folder.remove());
                
                // Add new folders based on keywords
                let folderHTML = '';
                keywords.forEach(keyword => {
                    let iconClass = 'fa-tag';
                    let colorClass = '';
                    
                    if (keyword === 'networking') {
                        iconClass = 'fa-network-wired';
                        colorClass = 'text-warning';
                    } else if (keyword === 'internship') {
                        iconClass = 'fa-briefcase';
                        colorClass = 'text-primary';
                    } else if (keyword === 'club events') {
                        iconClass = 'fa-calendar-alt';
                        colorClass = 'text-success';
                    }
                    
                    folderHTML += `
                        <div class="folder">
                            <span>
                                <i class="fas ${iconClass} ${colorClass}"></i>
                                ${keyword.charAt(0).toUpperCase() + keyword.slice(1)}
                            </span>
                            <span class="folder-count">0</span>
                        </div>
                    `;
                });
                
                // Insert after section header
                sectionHeader.insertAdjacentHTML('afterend', folderHTML);
            }
        }

        // Add notification styles
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize category management
            initCategoryManagement();
            
            // Add notification styles dynamically
            const style = document.createElement('style');
            style.textContent = `
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 15px;
                    border-radius: 4px;
                    color: white;
                    z-index: 1000;
                    opacity: 0;
                    transform: translateY(-20px);
                    transition: all 0.3s ease;
                }
                
                .notification.show {
                    opacity: 1;
                    transform: translateY(0);
                }
                
                .notification-success {
                    background-color: #52c41a;
                }
                
                .notification-warning {
                    background-color: #faad14;
                }
                
                .notification-error {
                    background-color: #f5222d;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>